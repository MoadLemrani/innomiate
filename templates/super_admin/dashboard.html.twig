{% extends 'base.html.twig' %}

{% block title %}
	Dashboard - Tableau de Bord
{% endblock %}

{% block body %}
    <!-- Flash Messages -->
    {% for type, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ type == 'error' ? 'danger' : type }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            </div>
        {% endfor %}
    {% endfor %}

    <div class="dashboard-container">
        <h1 class="dashboard-title">Bonjour, Administrateur üëã</h1>
        <p class="dashboard-subtitle">Bienvenue sur votre tableau de bord.</p>
        
        <!-- Navigation par onglets -->
        <div class="tabs-container">
            <div class="tabs-nav">
                <button class="tab-btn active" data-tab="all-users">
                    <span class="tab-icon">üë•</span>
                    Tous les utilisateurs
                </button>
                <button class="tab-btn" data-tab="participants">
                    <span class="tab-icon">üë§</span>
                    Participants
                </button>
                <button class="tab-btn" data-tab="superadmins">
                    <span class="tab-icon">‚ö°</span>
                    Administrateurs
                </button>
                <button class="tab-btn" data-tab="teams">
                    <span class="tab-icon">üèÜ</span>
                    √âquipes
                </button>
            </div>
            
            <!-- Onglet Tous les utilisateurs (Participants seulement) -->
            <div class="tab-content active" id="all-users">
                <div class="section-header">
                    <h2>Gestion des Utilisateurs (Participants uniquement)</h2>
                    <button class="export-btn" onclick="exportToExcel('all-users')">
                        üìä Exporter Excel
                    </button>
                </div>
                <div class="table-container">
                    <table class="styled-table" id="users-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Pr√©nom</th>
                                <th>Nom</th>
                                <th>R√¥les</th>
                                <th>Date d'inscription</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody">
                            {% for p in rows %}
                                {% if p.roles and 'ROLE_SUPERADMIN' not in p.roles %}
                                <tr>
                                    <td>{{p.email}}</td>
                                    <td>{{p.firstName}}</td>
                                    <td>{{p.lastName}}</td>
                                    <td>
                                        <span class="badge participant-badge">{{p.roles[0]}}</span>
                                    </td>
                                    <td>{{p.createdAt|date('Y-m-d H:i')}}</td>
                                    <td class="actions">
                                        <a href="#" class="action-link edit" onclick="toggleRole({{p.id}}, event)">Modifier le r√¥le</a>
                                        |
                                        <a href="#" class="action-link delete" onclick="deleteUser({{p.id}}, '{{p.email}}', event)">Supprimer</a>
                                    </td>
                                </tr>
                                {% endif %}
                                {% else %}
                                <tr>
                                    <td colspan="6">Aucune donn√©e</td>
                                </tr>
                                
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Onglet Participants -->
            <div class="tab-content" id="participants">
                <div class="section-header">
                    <h2>Liste des Participants</h2>
                    <button class="export-btn" onclick="exportToExcel('participants')">
                        üìä Exporter Excel
                    </button>
                </div>
                <div class="table-container">
                    <table class="styled-table" id="participants-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Pr√©nom</th>
                                <th>Nom</th>
                                <th>Code Participant</th>
                                <th>√âquipe</th>
                                <th>Code de l'√©quipe</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for u in parts%}
                            <tr id="participant-{{ u.id }}">
                                <td>{{u.courrierProfessionnel}}</td>
                                <td>{{u.prenom}}</td>
                                <td>{{u.nom}}</td>
                                <td><span class="status-badge verified">{{u.participantCode}}</span></td>
                                <td>
                                    <span class="display-mode">{{ u.team ? u.team.name : 'Pas d\'√©quipe encore' }}</span>
                                    <input class="edit-mode" type="text" value="{{ u.team ? u.team.name : '' }}" name="teamName" style="display:none;">
                                </td>
                                <td>
                                    <span class="display-mode">{{ u.team ? u.team.teamCode : '----' }}</span>
                                    <input class="edit-mode" type="text" value="{{ u.team ? u.team.teamCode : '' }}" name="teamCode" style="display:none;">
                                </td>
                                <td class="actions">
                                    <a href="#" class="action-link edit-btn" data-id="{{ u.id }}">Modifier</a>
                                    <button type="button" class="action-link save-btn" data-id="{{ u.id }}" style="display:none;">Enregistrer</button>
                                    |
                                    <a href="#" class="action-link delete" onclick="deleteParticipant({{u.id}}, '{{u.prenom}} {{u.nom}}', event)">Supprimer</a>
                                </td>
                            </tr>
                            {%else%}
                            <tr>
                                 <td colspan="7">Aucune donn√©e</td>
                            </tr>
                            {%endfor%}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Onglet Administrateurs -->
            <div class="tab-content" id="superadmins">
                <div class="section-header">
                    <h2>Liste des Administrateurs</h2>
                    <button class="export-btn" onclick="exportToExcel('superadmins')">
                        üìä Exporter Excel
                    </button>
                </div>
                <div class="table-container">
                    <table class="styled-table" id="superadmins-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Pr√©nom</th>
                                <th>Nom</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for a in superadmins %}
                            <tr>
                                <td>{{a.email}}</td>
                                <td>{{a.firstName}}</td>
                                <td>{{a.lastName}}</td>
                                <td class="actions">
                                    <a href="#" class="action-link delete" onclick="deleteAdmin({{a.id}}, '{{a.email}}', event)">Supprimer</a>
                                </td>
                            </tr>
                            {%else%}
                            <tr>
                                <td colspan="4" >Aucune donn√©e</td>
                            </tr>
                            {%endfor%}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Onglet √âquipes -->
            <div class="tab-content" id="teams">
                <div class="section-header">
                    <h2>Gestion des √âquipes</h2>
                    <button class="export-btn" onclick="exportToExcel('teams')">
                        üìä Exporter Excel
                    </button>
                </div>
                <div class="table-container">
                    <table class="styled-table" id="teams-table">
                        <thead>
                            <tr>
                                <th>Nom de l'√©quipe</th>
                                <th>Capitaine</th>
                                <th>Membres</th>
                                <th>Code de l'√©quipe</th>
                                <th>Date de cr√©ation</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        {%for team in teams%}
                            <tr>
                                <td>
                                    <div class="team-name">{{team.name}}</div>
                                </td>
                                <td>{{ team.leaderParticipant ? team.leaderParticipant.prenom ~ ' ' ~ team.leaderParticipant.nom : 'Pas de capitaine' }}</td>
                                <td>
                                    <span class="member-count" data-team-id="{{ team.id }}">{{ team.members|length }} membre{{ team.members|length > 1 ? 's' : '' }}</span>
                                </td>
                                <td>{{ team.teamCode }}</td>
                                <td>{{ team.createdAt ? team.createdAt|date('Y-m-d') : '' }}</td>
                                <td class="actions">
                                    <a href="#" class="action-link edit" data-action="edit" data-team-id="{{ team.id }}">Modifier</a>
                                    |
                                    <a href="#" class="action-link view" data-action="view" data-team-id="{{ team.id }}">D√©tails</a>
                                </td>
                            </tr>
                            {%else%}
                            <tr>
                                <td colspan="6">Aucune √©quipe</td>
                            </tr>
                            {%endfor%}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Modal pour les √©quipes -->
        <div id="teamModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div id="modalHeader" class="modal-header">
                    <h2 id="modalTitle" class="modal-title"></h2>
                    <button class="close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- Informations de l'√©quipe -->
                    <div class="team-info">
                        <h4>Informations de l'√©quipe</h4>
                        <div class="info-row">
                            <span class="info-label">Nom :</span>
                            <span id="teamName" class="info-value"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Capitaine :</span>
                            <span id="teamLeader" class="info-value"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Code :</span>
                            <span id="teamCode" class="info-value"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Date de cr√©ation :</span>
                            <span id="teamCreatedAt" class="info-value"></span>
                        </div>
                    </div>

                    <!-- Section des membres -->
                    <div class="members-section">
                        <h4>Membres de l'√©quipe</h4>
                        <div id="membersList">
                            <!-- Les membres seront ajout√©s dynamiquement -->
                        </div>

                        <!-- Formulaire d'ajout de membre (uniquement en mode √©dition) -->
                        <div id="addMemberForm" class="add-member-form">
                            <h5>Ajouter un nouveau membre</h5>
                            <div class="form-group">
                                <label for="newMemberName">Nom complet :</label>
                                <input type="text" id="newMemberName" placeholder="Entrez le nom du membre">
                            </div>
                            <div class="form-group">
                                <label for="newMemberCode">Code du membre :</label>
                                <input type="text" id="newMemberCode" placeholder="Entrez le code du membre">
                            </div>
                            <button class="btn btn-success" onclick="addMember()">Ajouter le membre</button>
                        </div>
                    </div>

                    <!-- Actions du modal (uniquement en mode √©dition) -->
                    <div id="modalActions" class="form-actions">
                        <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                        <button class="btn btn-success" onclick="saveChanges()">Sauvegarder</button>
                    </div>
                </div>
            </div>
        </div>

        <a href="{{ path('app_logout') }}" class="logout-link" onclick="window.location=this.href; return false;">üö™ D√©connexion</a>
    </div>

    <style>
        /* Flash Messages Styles */
        .alert {
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            border: 1px solid transparent;
            position: relative;
            animation: slideDown 0.3s ease-out;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }

        .alert-info {
            color: #0c5460;
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }

        .btn-close {
            position: absolute;
            top: 0.5rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.5;
        }

        .btn-close:hover {
            opacity: 1;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    
        :root {
            --bg: #ffffff;
            --text: #2c3e50;
            --secondary: #6c757d;
            --accent: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --card: #f8f9fa;
            --border: #dee2e6;
            --tab-bg: #f1f3f4;
            --tab-active: rgba(46, 204, 113, 0.1);
        }

        body {
            background: var(--bg);
            color: var(--text);
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
        }

        .dashboard-container {
            padding: 2rem;
            max-width: 1400px;
            margin: auto;
        }

        .dashboard-title {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            color: var(--text);
            font-weight: 700;
        }

        .dashboard-subtitle {
            color: var(--secondary);
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        /* Styles des onglets */
        .tabs-container {
            background: var(--card);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        .tabs-nav {
            display: flex;
            background: var(--tab-bg);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            color: var(--secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            white-space: nowrap;
            position: relative;
        }

        .tab-btn:hover {
            background: rgba(46, 204, 113, 0.05);
            color: var(--text);
        }

        .tab-btn.active {
            background: var(--tab-active);
            color: var(--accent);
            border-bottom: 3px solid var(--accent);
        }

        .tab-icon {
            font-size: 1.2rem;
        }

        .tab-content {
            display: none;
            padding: 2rem;
        }

        .tab-content.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-header h2 {
            margin: 0;
            font-size: 1.8rem;
            color: var(--text);
        }

        .export-btn {
            background: linear-gradient(135deg, var(--accent), #27ae60);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            background: var(--card);
        }

        .styled-table {
            width: 100%;
            border-collapse: collapse;
            background-color: transparent;
        }

        .styled-table th,
        .styled-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .styled-table th {
            background: linear-gradient(135deg, var(--accent), #27ae60);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .styled-table tbody tr {
            transition: all 0.3s ease;
        }

        .styled-table tbody tr:hover {
            background-color: rgba(46, 204, 113, 0.05);
            transform: scale(1.001);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: white;
        }

        .status-badge.verified {
            background: linear-gradient(135deg, var(--accent), #27ae60);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .admin-badge {
            background: linear-gradient(135deg, var(--danger), #c0392b);
        }

        .participant-badge {
            background: linear-gradient(135deg, var(--info), #2980b9);
        }

        .moderator-badge {
            background: linear-gradient(135deg, var(--warning), #e67e22);
        }

        .action-link {
            text-decoration: none;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .action-link.edit, .action-link.edit-btn {
            color: var(--info);
        }

        .action-link.save-btn {
            background-color: var(--info);
            color: white;
            border: none;
            cursor: pointer;
            font-family: inherit;
            font-size: inherit;
        }

        .action-link.delete {
            color: var(--danger);
        }

        .action-link.verify,
        .action-link.view,
        .action-link.permissions {
            color: var(--accent);
        }

        .action-link:hover {
            background: rgba(46, 204, 113, 0.1);
        }

        .action-link.save-btn:hover {
            background-color: #2980b9;
        }

        .actions {
            white-space: nowrap;
        }

        .team-name {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .team-avatar {
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent);
            border-radius: 50%;
            font-size: 1.2rem;
        }

        .member-count {
            color: var(--secondary);
            font-size: 0.9rem;
        }

        .score-highlight {
            font-weight: bold;
            color: var(--accent);
            font-size: 1.1rem;
        }

        .logout-link {
            display: inline-block;
            margin-top: 2rem;
            text-decoration: none;
            color: var(--danger);
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--danger);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .logout-link:hover {
            background: var(--danger);
            color: white;
            transform: translateY(-2px);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 1rem;
            }
            
            .section-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .tabs-nav {
                flex-direction: column;
            }
            
            .tab-btn {
                justify-content: center;
            }
        }
        
        /* Styles des modales */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: none;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            background-color: #007bff;
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header.edit-mode {
            background-color: #28a745;
        }

        .modal-header.view-mode {
            background-color: #6c757d;
        }

        .modal-title {
            margin: 0;
            font-size: 1.5em;
        }
        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
        }

        .close:hover,
        .close:focus {
            opacity: 0.7;
        }

        .modal-body {
            padding: 20px;
        }
        .team-info {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        .team-info h4 {
            margin-top: 0;
            color: #495057;
        }

        .info-row {
            display: flex;
            margin-bottom: 10px;
        }
        .info-label {
            font-weight: bold;
            width: 120px;
            color: #495057;
        }

        .info-value {
            flex: 1;
        }

        .members-section h4 {
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
        }
        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background-color: #fff;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: bold;
            color: #333;
        }
        .member-code {
            color: #6c757d;
            font-size: 0.9em;
        }

        .member-actions {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .add-member-form {
            margin-top: 20px;
            padding: 15px;
            border: 2px dashed #dee2e6;
            border-radius: 5px;
            background-color: #f8f9fa;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        .no-members {
            text-align: center;
            color: #6c757d;
            padding: 20px;
            font-style: italic;
        }

        /* Mode lecture seule */
        .view-mode .member-actions,
        .view-mode #addMemberForm,
        .view-mode #modalActions {
            display: none !important;
        }
    </style>

    <!-- SheetJS CDN for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // Functions with confirmation dialogs
        function deleteUser(id, email, event) {
            event.preventDefault();
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer l'utilisateur ${email} ?`)) {
                showNotification('Redirection vers la suppression...', 'info');
                setTimeout(() => {
                    window.location.href = `{{ path('user_delete', {id: '__ID__'}) }}`.replace('__ID__', id);
                }, 1000);
            }
        }

        function deleteParticipant(id, name, event) {
            event.preventDefault();
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer le participant ${name} ?`)) {
                showNotification('Redirection vers la suppression...', 'info');
                setTimeout(() => {
                    window.location.href = `{{ path('participant_delete', {id: '__ID__'}) }}`.replace('__ID__', id);
                }, 1000);
            }
        }

        function deleteAdmin(id, email, event) {
            event.preventDefault();
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer l'administrateur ${email} ?`)) {
                showNotification('Redirection vers la suppression...', 'info');
                setTimeout(() => {
                    window.location.href = `{{ path('user_delete', {id: '__ID__'}) }}`.replace('__ID__', id);
                }, 1000);
            }
        }

        function toggleRole(id, event) {
            event.preventDefault();
            if (confirm('√ätes-vous s√ªr de vouloir modifier le r√¥le de cet utilisateur ?')) {
                showNotification('Redirection vers la modification...', 'info');
                setTimeout(() => {
                    window.location.href = `{{ path('toggle_role', {id: '__ID__'}) }}`.replace('__ID__', id);
                }, 1000);
            }
        }

        // Modal functions
        let currentTeamId = null;
        let currentMode = null;

        // Event handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Team modal handlers
            document.querySelectorAll('.action-link[data-action]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const action = this.dataset.action;
                    const teamId = this.dataset.teamId;
                    openModal(action, teamId);
                });
            });

            // Close modal handlers
            document.querySelector('.close').addEventListener('click', closeModal);
            
            window.onclick = function(event) {
                const modal = document.getElementById('teamModal');
                if (event.target === modal) {
                    closeModal();
                }
            }
            
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeModal();
                }
            });

            // Inline editing handlers
            document.querySelectorAll(".edit-btn").forEach(function(btn) {
                btn.addEventListener("click", function(e) {
                    e.preventDefault();
                    let participantId = this.getAttribute('data-id');
                    let row = document.getElementById('participant-' + participantId);
                    
                    // Hide display elements
                    row.querySelectorAll(".display-mode").forEach(el => el.style.display = "none");
                    
                    // Show edit fields
                    row.querySelectorAll(".edit-mode").forEach(el => {
                        el.style.display = "inline-block";
                        let displayElement = el.previousElementSibling;
                        if (displayElement && displayElement.classList.contains('display-mode')) {
                            el.value = displayElement.textContent.trim();
                        }
                    });
                    
                    // Toggle buttons
                    this.style.display = "none";
                    row.querySelector(".save-btn").style.display = "inline-block";
                });
            });

            document.querySelectorAll(".save-btn").forEach(function(btn) {
                btn.addEventListener("click", function(e) {
                    e.preventDefault();
                    let participantId = this.getAttribute('data-id');
                    let row = document.getElementById('participant-' + participantId);
                    
                    let teamName = row.querySelector('input[name="teamName"]').value;
                    let teamCode = row.querySelector('input[name="teamCode"]').value;
                    
                    if (confirm('√ätes-vous s√ªr de vouloir enregistrer ces modifications ?')) {
                        let formData = new FormData();
                        formData.append('teamName', teamName);
                        formData.append('teamCode', teamCode);
                        
                        fetch('{{ path("modifier_participant", {id: "PARTICIPANT_ID"}) }}'.replace('PARTICIPANT_ID', participantId), {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Update display values
                                row.querySelectorAll(".display-mode")[0].textContent = teamName || 'Pas d\'√©quipe encore';
                                row.querySelectorAll(".display-mode")[1].textContent = teamCode || '----';
                                
                                // Switch to display mode
                                row.querySelectorAll(".display-mode").forEach(el => el.style.display = "inline-block");
                                row.querySelectorAll(".edit-mode").forEach(el => el.style.display = "none");
                                
                                // Toggle buttons
                                row.querySelector(".edit-btn").style.display = "inline-block";
                                row.querySelector(".save-btn").style.display = "none";
                                
                                showNotification('Modifications enregistr√©es avec succ√®s!', 'success');
                            } else {
                                showNotification('Erreur lors de l\'enregistrement: ' + data.message, 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            showNotification('Une erreur s\'est produite', 'error');
                        });
                    }
                });
            });

            // Tab functionality
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    btn.classList.add('active');
                    const targetTab = document.getElementById(btn.dataset.tab);
                    targetTab.classList.add('active');
                });
            });
        });

        function openModal(mode, teamId) {
            currentTeamId = teamId;
            currentMode = mode;
            
            fetch(`/admin/get-team/${teamId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erreur r√©seau');
                    }
                    return response.json();
                })
                .then(team => {
                    const modal = document.getElementById('teamModal');
                    const modalHeader = document.getElementById('modalHeader');
                    const modalTitle = document.getElementById('modalTitle');
                    
                    if (mode === 'edit') {
                        modalTitle.textContent = `Modifier l'√©quipe: ${team.name}`;
                        modalHeader.className = 'modal-header edit-mode';
                        modal.classList.remove('view-mode');
                    } else {
                        modalTitle.textContent = `D√©tails de l'√©quipe: ${team.name}`;
                        modalHeader.className = 'modal-header view-mode';
                        modal.classList.add('view-mode');
                    }

                    // Fill team information
                    document.getElementById('teamName').textContent = team.name;
                    document.getElementById('teamLeader').textContent = team.leaderParticipant ? 
                        `${team.leaderParticipant.prenom} ${team.leaderParticipant.nom}` : 
                        'Pas de capitaine';
                    document.getElementById('teamCode').textContent = team.teamCode;
                    document.getElementById('teamCreatedAt').textContent = team.createdAt || 'Non disponible';

                    displayMembers(team.members || []);

                    // Reset add member form
                    document.getElementById('newMemberName').value = '';
                    document.getElementById('newMemberCode').value = '';

                    modal.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Erreur lors du chargement des donn√©es de l\'√©quipe', 'error');
                });
        }

        function displayMembers(members) {
            const membersList = document.getElementById('membersList');

            if (!members || members.length === 0) {
                membersList.innerHTML = '<div class="no-members">Aucun membre dans cette √©quipe</div>';
                return;
            }

            membersList.innerHTML = members.map(member => `
                <div class="member-item" data-member-id="${member.id}">
                    <div class="member-info">
                        <div class="member-name">${member.prenom} ${member.nom}</div>
                        <div class="member-code">Code: ${member.participantCode || 'Non d√©fini'}</div>
                        ${member.email ? `<div class="member-email" style="font-size: 0.8em; color: #6c757d;">${member.email}</div>` : ''}
                    </div>
                    <div class="member-actions">
                        <button class="btn btn-danger" onclick="removeMember(${member.id}, '${member.prenom} ${member.nom}')">
                            Supprimer
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function addMember() {
            const code = document.getElementById('newMemberCode').value.trim();

            if (!code) {
                showNotification('Veuillez entrer le code participant', 'warning');
                return;
            }

            if (confirm('√ätes-vous s√ªr de vouloir ajouter ce membre √† l\'√©quipe ?')) {
                fetch(`/admin/team/${currentTeamId}/add-member`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: `participantCode=${encodeURIComponent(code)}`
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message, 'success');
                        openModal(currentMode, currentTeamId);
                        updateTeamRow(currentTeamId);
                    } else {
                        showNotification(data.message || 'Erreur lors de l\'ajout', 'error');
                    }
                })
                .catch(err => {
                    console.error(err);
                    showNotification("Erreur r√©seau lors de l'ajout", 'error');
                });
            }
        }

        function removeMember(memberId, memberName) {
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer ${memberName} de l'√©quipe ?`)) {
                return;
            }

            fetch(`/admin/team/${currentTeamId}/remove-member/${memberId}`, {
                method: 'DELETE',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(async res => {
                if (res.status === 405) {
                    return fetch(`/admin/team/${currentTeamId}/remove-member/${memberId}`, {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });
                }
                return res;
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    openModal(currentMode, currentTeamId);
                    updateTeamRow(currentTeamId);
                } else {
                    showNotification(data.message || 'Erreur lors de la suppression', 'error');
                }
            })
            .catch(err => {
                console.error(err);
                showNotification("Erreur r√©seau lors de la suppression", 'error');
            });
        }

        function saveChanges() {
            if (confirm('√ätes-vous s√ªr de vouloir sauvegarder toutes les modifications ?')) {
                showNotification('Modifications sauvegard√©es avec succ√®s!', 'success');
                closeModal();
            }
        }

        function closeModal() {
            const modal = document.getElementById('teamModal');
            modal.style.display = 'none';
            currentTeamId = null;
            currentMode = null;
        }

        function updateTeamRow(teamId) {
            fetch(`/admin/get-team/${teamId}`)
                .then(res => res.json())
                .then(team => {
                    const cell = document.querySelector(`.member-count[data-team-id="${teamId}"]`);
                    if (cell) {
                        cell.textContent = `${team.members.length} membre${team.members.length > 1 ? 's' : ''}`;
                    }
                })
                .catch(err => console.error("Erreur maj tableau:", err));
        }

        // Excel export function (FIXED)
        function exportToExcel(tabName) {
            let table;
            let filename;
            
            switch(tabName) {
                case 'all-users':
                    table = document.getElementById('users-table');
                    filename = 'tous_les_utilisateurs.xlsx';
                    break;
                case 'participants':
                    table = document.getElementById('participants-table');
                    filename = 'participants.xlsx';
                    break;
                case 'superadmins':
                    table = document.getElementById('superadmins-table');
                    filename = 'administrateurs.xlsx';
                    break;
                case 'teams':
                    table = document.getElementById('teams-table');
                    filename = 'equipes.xlsx';
                    break;
                default:
                    showNotification('Tableau non trouv√©', 'error');
                    return;
            }

            if (!table) {
                showNotification('Erreur: Tableau non trouv√©', 'error');
                return;
            }

            try {
                // Check if XLSX library is loaded
                if (typeof XLSX === 'undefined') {
                    showNotification('Erreur: Biblioth√®que Excel non charg√©e', 'error');
                    return;
                }

                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Convert HTML table to worksheet
                const ws = XLSX.utils.table_to_sheet(table);
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, tabName);
                
                // Save file
                XLSX.writeFile(wb, filename);
                
                showNotification('Export Excel r√©ussi!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Erreur lors de l\'export Excel: ' + error.message, 'error');
            }
        }

        // Notification function (IMPROVED)
        function showNotification(message, type) {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="background:none; border:none; color:white; font-size:18px; cursor:pointer; margin-left:10px;">&times;</button>
            `;
            
            let bgColor;
            switch(type) {
                case 'success':
                    bgColor = '#28a745';
                    break;
                case 'error':
                    bgColor = '#dc3545';
                    break;
                case 'warning':
                    bgColor = '#ffc107';
                    break;
                case 'info':
                    bgColor = '#17a2b8';
                    break;
                default:
                    bgColor = '#6c757d';
            }

            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 2rem;
                background: ${bgColor};
                color: white;
                border-radius: 8px;
                font-weight: 600;
                z-index: 1001;
                animation: slideIn 0.3s ease;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                display: flex;
                align-items: center;
                justify-content: space-between;
                min-width: 300px;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Animation CSS for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
{% endblock %}